# Lab 1C â€“ CloudWatch Logs Insights Incident Runbook

## Purpose

This runbook provides a **repeatable incident response workflow** using CloudWatch Logs Insights to quickly determine whether an outage or alarm is caused by:

* External traffic / attack pressure (WAF)
* Application or backend failure (EC2 / RDS)

It is designed for **Lab 1C Bonus-B / Bonus-F** and mirrors real-world SRE / SOC procedures.

---

## Scope & Assumptions

### Logs Covered

* **AWS WAF logs** (CloudWatch destination)
* **Application logs** from EC2 instances

### Logs NOT Covered

* ALB access logs (stored in S3)

  * Correlate via CloudWatch metrics (5xx alarms)
  * Optional future analysis via Athena

---

## Required Inputs (Fill In)

| Item             | Value                                    |
| ---------------- | ---------------------------------------- |
| Project / Prefix | `<project>`                              |
| WAF Log Group    | `aws-waf-logs-<project>-webacl01`        |
| App Log Group    | `/aws/ec2/<project>-rds-app`             |
| Time Window      | Last **15 minutes** (or incident window) |

---

## How to Use This Runbook

1. Open **CloudWatch â†’ Logs Insights**
2. Select **ONE log group at a time**
3. Set the **time range** to match the alarm
4. Paste the query exactly as shown
5. Interpret results using the guidance below

---

# Section A â€” WAF (External Traffic / Attack Analysis)

**Log Group:** `aws-waf-logs-<project>-webacl01`

---

## A1 â€” Current Traffic Actions (ALLOW vs BLOCK)

```sql
fields @timestamp, action
| stats count() as hits by action
| sort hits desc
```

**Why:** Determine whether WAF is actively blocking traffic.

---

## A2 â€” Top Client IPs

```sql
fields @timestamp, httpRequest.clientIp as clientIp
| stats count() as hits by clientIp
| sort hits desc
| limit 25
```

**Why:** Identify heavy hitters or scanners.

---

## A3 â€” Top Requested URIs

```sql
fields @timestamp, httpRequest.uri as uri
| stats count() as hits by uri
| sort hits desc
| limit 25
```

**Why:** See what attackers or users are attempting to access.

---

## A4 â€” Blocked Requests Only

```sql
fields @timestamp, action, httpRequest.clientIp as clientIp, httpRequest.uri as uri
| filter action = "BLOCK"
| stats count() as blocks by clientIp, uri
| sort blocks desc
| limit 25
```

**Why:** Understand exactly what WAF is protecting you from.

---

## A5 â€” Blocking WAF Rules

```sql
fields @timestamp, action, terminatingRuleId, terminatingRuleType
| filter action = "BLOCK"
| stats count() as blocks by terminatingRuleId, terminatingRuleType
| sort blocks desc
| limit 25
```

**Why:** Identify which managed or custom rules are triggering.

---

## A6 / A7 â€” Suspicious Scanner Activity

```sql
fields @timestamp, httpRequest.clientIp as clientIp, httpRequest.uri as uri
| filter uri =~ /wp-login|xmlrpc|\.env|admin|phpmyadmin|\.git|login/
| stats count() as hits by clientIp, uri
| sort hits desc
| limit 50
```

**Why:** Detect common automated attack patterns.

---

## A8 â€” Country / Geo Distribution (If Present)

```sql
fields @timestamp, httpRequest.country as country
| stats count() as hits by country
| sort hits desc
| limit 25
```

**Why:** Identify geographic attack concentration.

---

# Section B â€” Application Logs (Backend Health)

**Log Group:** `/aws/ec2/<project>-rds-app`

---

## B1 â€” Error Rate Over Time

```sql
fields @timestamp, @message
| filter @message like /ERROR|Exception|Traceback|DB|timeout|refused/i
| stats count() as errors by bin(1m)
| sort bin(1m) asc
```

**Why:** Establish the exact failure window.

---

## B2 â€” Recent Database Failures

```sql
fields @timestamp, @message
| filter @message like /DB|mysql|timeout|refused|Access denied|could not connect/i
| sort @timestamp desc
| limit 50
```

**Why:** Triage DB connectivity and auth issues.

---

## B3 â€” Failure Classification (Creds vs Network)

```sql
fields @timestamp, @message
| filter @message like /Access denied|authentication failed|timeout|refused|no route|could not connect/i
| stats count() as hits by
  case(
    @message like /Access denied|authentication failed/i, "Creds/Auth",
    @message like /timeout|no route/i, "Network/Route",
    @message like /refused/i, "Port/SG/ServiceRefused",
    "Other"
  )
| sort hits desc
```

**Why:** Quickly determine root cause category.

---

## B4 â€” Structured JSON Errors (Optional)

```sql
fields @timestamp, level, event, reason
| filter level="ERROR"
| stats count() as n by event, reason
| sort n desc
```

**Requires:** Application emits JSON logs.

---

# Section C â€” Incident Correlation Workflow

## Step 1 â€” Confirm Timing

* Check CloudWatch alarm window
* Run **B1** to confirm error spike

---

## Step 2 â€” Attack vs Backend

* Run **A1** and **A6**
* If BLOCKs spike â†’ external pressure
* If WAF quiet + errors spike â†’ backend issue

---

## Step 3 â€” Backend Triage

* Run **B2** and **B3**
* Interpret:

  * `Access denied` â†’ Secrets / credential drift
  * `timeout` â†’ Security Groups / routing / RDS

Retrieve known-good values from:

* SSM Parameter Store: `/lab/db/*`
* Secrets Manager: `/<project>/rds/mysql`

---

## Step 4 â€” Verify Recovery

* Errors drop in **B1**
* WAF stabilizes (**A6**)
* Alarm returns to **OK**
* Smoke test:

```bash
curl https://app.chewbacca-growl.com/list
```

---

# Optional â€” Terraform Saved Queries (Future Enhancement)

CloudWatch Logs Insights **saved queries** can be created using `aws_cloudwatch_query_definition` to make this runbook executable with two clicks.

Example:

```hcl
resource "aws_cloudwatch_query_definition" "waf_top_actions" {
  name = "WAF-Top-Actions"
  log_group_names = ["aws-waf-logs-${var.project}-webacl01"]

  query_string = <<EOF
fields @timestamp, action
| stats count() as hits by action
| sort hits desc
EOF
}
```

Repeat per query for full automation.

---

## Runbook Maturity Level

* âœ… Tier 1: Manual queries
* âœ… Tier 2: Saved queries
* ðŸ”œ Tier 3: Athena + S3 log lake
* ðŸ”œ Tier 4: Automated incident classification
